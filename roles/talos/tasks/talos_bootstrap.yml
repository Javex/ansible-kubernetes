# Talos bootstrapping command that might fail if the node is already set up
- name: Apply config file
  ansible.builtin.command:
    chdir: "{{ talos_tmp_path.path }}"
    cmd: >
      ./talosctl
      apply-config
      --insecure
      --nodes {{ hostvars[talos_vm_name].ansible_host }}
      --file controlplane.yaml
  ignore_errors: true
  register: talos_apply_bootstrap
  changed_when: false

# Apply config only when not bootstrapping, i.e. the insecure version above
# failed when trying to apply the config
- name: Apply config file
  ansible.builtin.command:
    chdir: "{{ talos_tmp_path.path }}"
    cmd: >
      ./talosctl
      --talosconfig talosconfig
      apply-config
      --nodes {{ hostvars[talos_vm_name].ansible_host }}
      --file controlplane.yaml
  when: talos_apply_bootstrap.failed
  changed_when: false
