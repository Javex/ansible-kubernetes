- name: Include task to determine etcd status
  ansible.builtin.include_tasks: etcd_status.yml

# TODO: This command currently hard codes the node name. When setting up
# clusters with more than one node I'd like to have a configuration that
# determines which node is used for bootstrapping and only run this command
# on that node.
- name: Run bootstrap command
  when: talos_etcd_status == 'Preparing'
  ansible.builtin.command:
    chdir: "{{ talos_tmp_path.path }}"
    cmd: >
      ./talosctl
      --talosconfig talosconfig
      --nodes {{ hostvars['talos-prod-control-1'].ansible_host }}
      bootstrap

- name: Get kubeconfig to start interacting with Kubernetes
  ansible.builtin.command:
    chdir: "{{ talos_tmp_path.path }}"
    cmd: >
      ./talosctl
      --talosconfig talosconfig
      kubeconfig .
  changed_when: false

- name: Set up Kubernetes
  environment: "{{ kubernetes_env_vars }}"
  block:
    - name: Wait for cluster to be ready
      kubernetes.core.k8s_cluster_info:
      retries: 12
      delay: 10
